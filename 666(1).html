<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="bg-[#030712] text-[#f3f4f6] min-h-screen overflow-x-hidden">
    <!-- 登录界面 -->
    <div id="authScreen" class="h-screen flex flex-col p-6 justify-center gap-6">
        <div class="text-center mb-10">
            <i class="fa fa-github text-6xl text-gray-400 mb-4"></i>
            <h1 class="text-3xl font-bold">GitHub文件管理器</h1>
        </div>
        <div class="shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-xl p-6 flex flex-col gap-4">
            <input type="text" id="tokenInput" placeholder="输入GitHub访问令牌" 
                class="box-shadow-[inset_3px_3px_6px_rgba(0,0,0,0.3),inset_-3px_-3px_6px_rgba(75,85,99,0.1)] bg-[#030712] rounded-lg p-3 outline-none text-[#f3f4f6]">
            <button id="authBtn" class="box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#6b7280] hover:bg-[#4b5563] transition-colors rounded-lg p-3 font-medium">
                登录
            </button>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="app" class="hidden flex flex-col h-screen">
        <header class="bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] py-3 px-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-github text-gray-400"></i>
                <h1 class="font-bold text-lg truncate" id="currentRepo">选择仓库</h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="logoutBtn" class="p-2 rounded-full hover:bg-[#6b7280]/20 transition-colors" title="退出登录">
                    <i class="fa fa-sign-out"></i>
                </button>
                <button id="repoBtn" class="p-2 rounded-full hover:bg-[#6b7280]/20 transition-colors" title="仓库列表">
                    <i class="fa fa-github text-xl"></i>
                </button>
            </div>
        </header>

        <!-- 路径导航 -->
        <div class="bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] py-2 px-4 overflow-x-auto whitespace-nowrap hidden" id="pathNavContainer">
            <div id="pathNav" class="flex gap-1 text-sm"></div>
        </div>

        <!-- 主内容区 -->
        <main class="flex-1 overflow-y-auto">
            <div id="repoList" class="p-3 space-y-2">
                <div class="flex justify-center items-center h-full py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div>
                </div>
            </div>
            <div id="fileList" class="p-3 space-y-2 hidden">
                <div class="flex justify-center items-center h-full py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div>
                </div>
            </div>
        </main>

        <!-- 底部操作栏 -->
        <footer class="bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] py-3 px-4 flex justify-around">
            <button id="backBtn" class="flex flex-col items-center justify-center p-2 w-1/4" title="返回上级">
                <i class="fa fa-arrow-up text-xl"></i>
            </button>
            <button id="newFolderBtn" class="flex flex-col items-center justify-center p-2 w-1/4" onclick="createFolder()" title="新建文件夹">
                <i class="fa fa-folder text-xl"></i>
            </button>
            <button id="uploadBtn" class="flex flex-col items-center justify-center p-2 w-1/4" title="上传文件">
                <i class="fa fa-upload text-xl"></i>
            </button>
            <button id="refreshBtn" class="flex flex-col items-center justify-center p-2 w-1/4" title="刷新">
                <i class="fa fa-refresh text-xl"></i>
            </button>
        </footer>
    </div>

    <!-- 编辑文件模态框 -->
    <div id="editModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-xl flex flex-col w-full max-w-5xl min-h-[60vh]">
            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                <h3 class="text-lg font-bold" id="editFileName">编辑文件</h3>
                <button id="closeEditModal" class="p-2 hover:bg-[#6b7280]/20 rounded-full">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-3 m-[0.1rem_0] rounded-[0.375rem]" id="editStatus"></div>
            <div class="flex-1 overflow-hidden relative">
                <div id="editorOverlay" class="absolute inset-0 flex items-center justify-center bg-[rgba(17,24,39,0.7)] z-10 rounded-[0.375rem] opacity-0 pointer-events-none transition-opacity-[0.3s_ease]">
                    <div class="text-center"><i class="fa fa-spinner fa-spin text-2xl"></i></div>
                </div>
                <div class="save-notification absolute top-10 right-10 bg-[rgba(15,81,50,0.9)] text-white p-[5px_10px] rounded-4px text-14px z-5 opacity-0 transform -translate-y-20 transition-[opacity_0.3s_ease,transform_0.3s_ease]" id="saveNotification">
                    <i class="fa fa-check mr-1"></i> 保存成功
                </div>
                <textarea id="fileContent" class="box-shadow-[inset_3px_3px_6px_rgba(0,0,0,0.3),inset_-3px_-3px_6px_rgba(75,85,99,0.1)] bg-[#030712] w-full h-full resize-none p-3 outline-none min-h-[70vh]"></textarea>
            </div>
            <div class="flex gap-3 p-3 border-t border-gray-700">
                <button id="cancelEdit" class="flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] hover:bg-[#111827]/70 transition-colors rounded-lg p-3">取消</button>
                <button id="saveEdit" class="flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#6b7280] hover:bg-[#4b5563] transition-colors rounded-lg p-3">保存修改</button>
            </div>
        </div>
    </div>

    <!-- 文件上传面板 -->
    <div id="uploadPanel" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] rounded-lg p-4 w-[91.666667%] max-w-md hidden z-40">
        <h3 class="font-medium mb-3">文件上传中</h3>
        <div id="uploadItems" class="space-y-3 max-h-40 overflow-y-auto"></div>
    </div>

    <!-- 通用模态框 -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-xl p-5 w-[91.666667%] max-w-md">
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="contextMenu" class="fixed bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] rounded-lg shadow-lg z-50 hidden w-48">
        <div class="py-1" id="contextMenuItems"></div>
    </div>

    <!-- Toast提示 -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-[rgba(17,24,39,0.8)] backdrop-blur-[10px] box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] px-4 py-2 rounded-full hidden z-30">
        <span id="toastMessage"></span>
    </div>

    <!-- 隐藏的文件上传input -->
    <input type="file" id="fileUploadInput" multiple class="hidden">



<script>
<!-- 状态管理 -->
const state = {
    token: localStorage.getItem('gh_token') || null,
    currentRepo: null,
    currentPath: '',
    files: [],
    repos: [],
    selectedFile: null,
    selectedRepo: null,
    uploadQueue: [],
    editingFile: null,
    fileSha: '',
    originalContent: '',
    proxyUrl: 'https://gh-proxy.com/',
    navHistory: ['root']
};

const el = Object.fromEntries(
    [
        'authScreen', 'app', 'tokenInput', 'authBtn', 'fileList', 'repoList',
        'pathNav', 'pathNavContainer', 'currentRepo', 'logoutBtn', 'newFolderBtn',
        'uploadBtn', 'refreshBtn', 'repoBtn', 'backBtn', 'modalOverlay', 'modalContent',
        'contextMenu', 'contextMenuItems', 'toast', 'toastMessage', 'uploadPanel',
        'uploadItems', 'editModal', 'editFileName', 'fileContent', 'closeEditModal',
        'cancelEdit', 'saveEdit', 'editStatus', 'editorOverlay', 'saveNotification',
        'fileUploadInput'
    ].map(id => [id, document.getElementById(id)])
);

<!-- 工具函数 -->
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
        js: 'fa-code text-yellow-500',
        html: 'fa-html5 text-orange-500',
        css: 'fa-css3 text-blue-500',
        json: 'fa-file-code-o text-gray-400',
        md: 'fa-file-text-o text-blue-400',
        png: 'fa-file-image-o text-green-400',
        jpg: 'fa-file-image-o text-green-400',
        jpeg: 'fa-file-image-o text-green-400',
        gif: 'fa-file-image-o text-green-400',
        pdf: 'fa-file-pdf-o text-red-500',
        zip: 'fa-file-zip-o text-yellow-600',
        git: 'fa-git text-red-600'
    };
    return icons[ext] || 'fa-file-o text-gray-400';
}
function formatSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
function formatRelativeTime(date) {
    const diffMs = new Date() - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    if (diffMins < 1) return '刚刚';
    if (diffMins < 60) return `${diffMins}分钟前`;
    if (diffHours < 24) return `${diffHours}小时前`;
    if (diffDays < 30) return `${diffDays}天前`;
    return date.toLocaleDateString();
}
function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

<!-- 视图控制 -->
function toggleView(showRepoList) {
    if (showRepoList) {
        el.repoList.classList.remove('hidden');
        el.fileList.classList.add('hidden');
        el.pathNavContainer.classList.add('hidden');
        el.currentRepo.textContent = '选择仓库';
    } else {
        el.repoList.classList.add('hidden');
        el.fileList.classList.remove('hidden');
        el.pathNavContainer.classList.remove('hidden');
    }
}
const showAuth = () => (el.authScreen.classList.remove('hidden'), el.app.classList.add('hidden'));
const showApp = () => (el.authScreen.classList.add('hidden'), el.app.classList.remove('hidden'));
const showModal = content => (el.modalContent.innerHTML = content, el.modalOverlay.classList.remove('hidden'), el.modalOverlay.classList.add('flex'));
const hideModal = () => (el.modalOverlay.classList.add('hidden'), el.modalOverlay.classList.remove('flex'));
const showToast = message => (el.toastMessage.textContent = message, el.toast.classList.remove('hidden'), setTimeout(() => el.toast.classList.add('hidden'), 3000));
function showSaveNotification() {
    el.saveNotification.classList.add('opacity-100', 'translate-y-0');
    setTimeout(() => el.saveNotification.classList.remove('opacity-100', 'translate-y-0'), 3000);
}

<!-- 仓库管理 -->
async function fetchRepos() {
    try {
        state.repos = [];
        el.repoList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
        const res = await fetch('https://api.github.com/user/repos?timestamp=' + Date.now(), {
            headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
        });
        if (!res.ok) throw new Error('获取仓库失败');
        state.repos = await res.json();
        renderRepoList();
        showRepoListView();
    } catch (err) {
        showToast('加载仓库失败');
        console.error(err);
    }
}
function renderRepoList() {
    el.repoList.innerHTML = state.repos.length === 0
        ? '<div class="text-center py-10 text-gray-400"><i class="fa fa-github text-4xl mb-2"></i><p>没有找到仓库</p></div>'
        : '';
    state.repos.forEach(repo => {
        const item = document.createElement('div');
        item.className = `box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-lg p-3 flex items-center gap-3 hover:bg-[#6b7280]/10 transition-colors cursor-pointer ${state.currentRepo === repo.full_name ? 'ring-2 ring-blue-500' : ''}`;
        item.innerHTML = `
            <div class="w-10 h-10 flex items-center justify-center rounded-8px bg-[#111827]/50"><i class="fa fa-github text-gray-400"></i></div>
            <div class="flex-1 min-w-0">
                <p class="font-medium truncate">${repo.name}</p>
                <p class="text-xs text-gray-400 mt-1">
                ${repo.private ? '私有仓库' : '公开仓库'}
                ${(repo.size || repo.updated_at) ? ' · ' : ''}
                ${repo.size ? formatSize(repo.size * 1024) : ''}
                ${repo.size && repo.updated_at ? ' · ' : ''}
                ${formatRelativeTime(new Date(repo.updated_at))} </p>
                <p class="text-xs text-gray-400 truncate mt-1">${repo.description || ''}</p>

            </div>
        `;
        item.addEventListener('click', () => {
            state.currentRepo = repo.full_name;
            state.currentPath = '';
            el.currentRepo.textContent = repo.name;
            renderPathNav();
            fetchFiles();
            toggleView(false);
        });
        // 长按事件
        let pressTimer;
        ['touchstart', 'mousedown'].forEach(event => {
            item.addEventListener(event, (e) => {
                pressTimer = setTimeout(() => { e.preventDefault(); state.selectedRepo = repo; showRepoContextMenu(e, repo); }, 500);
            });
        });
        ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
            item.addEventListener(event, () => clearTimeout(pressTimer));
        });
        el.repoList.appendChild(item);
    });
}
function showRepoListView() {
    el.repoList.classList.remove('hidden');
    el.fileList.classList.add('hidden');
    el.pathNavContainer.classList.add('hidden');
    el.currentRepo.textContent = '选择仓库';
    state.currentRepo = null;
    state.currentPath = '';
}

<!-- 文件管理 -->
async function fetchFiles() {
    if (!state.currentRepo) return;
    el.fileList.innerHTML = `<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>`;
    try {
        const timestamp = Date.now();
        const res = await fetch(`https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}?t=${timestamp}`, {
            headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' },
            cache: 'no-store'
        });
        if (!res.ok) {
            if (res.status === 404) { state.files = []; renderFileList(); return; }
            throw new Error('加载文件失败');
        }
        const data = await res.json();
        if (data.message) throw new Error(data.message);
        state.files = Array.isArray(data) ? data : [];
        state.files.sort((a, b) =>
            a.type === 'dir' && b.type !== 'dir' ? -1 :
            a.type !== 'dir' && b.type === 'dir' ? 1 :
            a.name.localeCompare(b.name)
        );
        // 获取每个文件的最后修改时间
        await Promise.all(state.files.map(async (file) => {
            try {
                const [owner, repo] = state.currentRepo.split('/');
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/commits?path=${file.path}&per_page=1`, {
                    headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
                });
                const commits = await res.json();
                if (Array.isArray(commits) && commits.length > 0) {
                    file.last_modified = commits[0].commit.committer.date;
                }
            } catch (e) {
                file.last_modified = null;
            }
        }));
        renderFileList();
    } catch (err) {
        if (err.message.includes('404')) { state.files = []; renderFileList(); return; }
        showToast('加载文件失败: ' + err.message);
        console.error(err);
    }
}
function renderFileList() {
    el.fileList.innerHTML = state.files.length === 0
        ? '<div class="text-center py-10 text-gray-400"><i class="fa fa-github text-4xl mb-2"></i><p>仓库为空</p></div>'
        : '';
    state.files.forEach(file => {
        const isDir = file.type === 'dir';
        const icon = isDir ? 'fa-folder text-yellow-500' : getFileIcon(file.name);
        const item = document.createElement('div');
        item.className = 'box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#111827] rounded-lg p-3 flex items-center gap-3 hover:bg-[#6b7280]/10 transition-colors cursor-pointer';
        item.innerHTML = `
            <div class="w-10 h-10 flex items-center justify-center rounded-8px bg-[#111827]/50"><i class="fa ${icon}"></i></div>
            <div class="flex-1 min-w-0">
                <p class="font-medium truncate">${file.name}</p>
                <p class="text-xs text-gray-400">
                    ${isDir ? '文件夹' : formatSize(file.size)} · ${file.last_modified ? formatRelativeTime(new Date(file.last_modified)) : '加载中…'}
                </p>
            </div>
        `;
        item.addEventListener('click', (e) => {
            if (e.imagePreviewAction) return;
            isDir ? navigateToDir(file.name) : editFile(file);
        });
        // 长按事件
        let pressTimer;
        ['touchstart', 'mousedown'].forEach(event => {
            item.addEventListener(event, (e) => {
                pressTimer = setTimeout(() => { e.preventDefault(); showContextMenu(e, file); }, 700);
            });
        });
        ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
            item.addEventListener(event, () => clearTimeout(pressTimer));
        });
        el.fileList.appendChild(item);
    });
}

<!-- 路径导航 -->
function renderPathNav() {
    el.pathNav.innerHTML = '';
    const parts = state.currentPath.split('/').filter(p => p);
    let currentPath = '';
    addPathItem('/', '');
    parts.forEach((part) => {
        currentPath += part + '/';
        addPathItem(part, currentPath);
    });
}
function addPathItem(name, path) {
    const item = document.createElement('span');
    item.className = 'cursor-pointer hover:text-gray-300';
    item.textContent = name;
    item.dataset.path = path;
    item.addEventListener('click', () => {
        el.fileList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
        navigateToPath(path);
    });
    el.pathNav.appendChild(item);
    if (name !== '/') el.pathNav.appendChild(document.createTextNode(' / '));
}
function navigateToDir(dirName) {
    const newPath = state.currentPath ? `${state.currentPath}${dirName}/` : `${dirName}/`;
    state.navHistory.push(newPath);
    state.currentPath = newPath;
    renderPathNav();
    fetchFiles();
}
function navigateToPath(path) {
    state.navHistory.push(path);
    state.currentPath = path;
    renderPathNav();
    fetchFiles();
}
        function goUp() {
    if (!state.currentRepo) return;
    if (!state.currentPath) {
        showRepoListView();
        return;
    }
    const parts = state.currentPath.split('/').filter(p => p);
    parts.pop();
    state.currentPath = parts.length ? parts.join('/') + '/' : '';
    renderPathNav();
    el.fileList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
    fetchFiles(); 
    showToast('已返回上一级');
}

<!-- 事件监听 -->
function setupEventListeners() {
    // 认证相关
    el.authBtn.addEventListener('click', () => {
        const token = el.tokenInput.value.trim();
        if (token) {
            localStorage.setItem('gh_token', token);
            state.token = token;
            showApp();
            fetchRepos();
        } else {
            showToast('请输入令牌');
        }
    });
    el.logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('gh_token');
        state.token = null;
        state.repos = [];
        state.currentRepo = null;
        showAuth();
    });
// 导航相关 刷新首页
el.backBtn.addEventListener('click', goUp);
el.repoBtn.addEventListener('click', showRepoListView);
el.refreshBtn.addEventListener('click', () => {
    if (!state.currentRepo) {
        fetchRepos(); 
    } else {
        fetchFiles(); 
    }
});
    // 编辑相关
    el.closeEditModal.addEventListener('click', hideEditModal);
    el.cancelEdit.addEventListener('click', hideEditModal);
    el.saveEdit.addEventListener('click', saveEditedFile);
    // 点击或滑动任意位置关闭上下文菜单
    document.addEventListener('click', hideContextMenu);
    document.addEventListener('touchstart', (e) => {
        if (!el.contextMenu.contains(e.target)) hideContextMenu();
    });
    document.addEventListener('touchmove', (e) => {
        if (!el.contextMenu.contains(e.target)) hideContextMenu();
    });
    // 点击空白处关闭模态框
    el.modalOverlay.addEventListener('click', (e) => {
        if (e.target === el.modalOverlay) hideModal();
    });
}

<!-- 初始化 -->
function init() {
    state.token ? (showApp(), fetchRepos()) : showAuth();
    setupEventListeners();
}
document.addEventListener('DOMContentLoaded', init);
</script>



<script>
<!-- 上下文菜单 -->
function positionContextMenu(e) {
    const rect = e.target.closest('div[class*="box-shadow"]').getBoundingClientRect();
    const menuWidth = 192, windowWidth = window.innerWidth, windowHeight = window.innerHeight;
    let leftPos = rect.right + menuWidth + 10 <= windowWidth ? rect.right + 10
        : rect.left - menuWidth - 10 >= 0 ? rect.left - menuWidth - 10
        : Math.max(10, Math.min(windowWidth - menuWidth - 10, (rect.left + rect.right - menuWidth) / 2));
    let topPos = rect.top;
    const estimatedMenuHeight = 40 * 8;
    if (topPos + estimatedMenuHeight > windowHeight) {
        topPos = Math.max(20, windowHeight - estimatedMenuHeight - 40);
    }
    return { top: topPos, left: leftPos };
}
function showContextMenu(e, file) {
    state.selectedFile = file;
    const position = positionContextMenu(e);
    const menu = el.contextMenu;
    menu.style.top = `${position.top}px`;
    menu.style.left = `${position.left}px`;
    menu.style.opacity = '0';
    menu.style.transform = 'scale(0.8)';
    menu.classList.remove('hidden');
    menu.style.display = 'block';
    let start = null, duration = 150;
    function animate(timestamp) {
        if (!start) start = timestamp;
        const progress = Math.min((timestamp - start) / duration, 1);
        menu.style.opacity = progress.toString();
        menu.style.transform = `scale(${0.8 + 0.2 * progress})`;
        if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
    renderContextMenuItems(file);
}
function showRepoContextMenu(e, repo) {
    state.selectedRepo = repo;
    const position = positionContextMenu(e);
    const menu = el.contextMenu;
    menu.style.top = `${position.top}px`;
    menu.style.left = `${position.left}px`;
    menu.style.opacity = '0';
    menu.style.transform = 'scale(0.8)';
    menu.classList.remove('hidden');
    menu.style.display = 'block';
    let start = null, duration = 150;
    function animate(timestamp) {
        if (!start) start = timestamp;
        const progress = Math.min((timestamp - start) / duration, 1);
        menu.style.opacity = progress.toString();
        menu.style.transform = `scale(${0.8 + 0.2 * progress})`;
        if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
    renderRepoContextMenuItems(repo);
}
function renderRepoContextMenuItems(repo) {
    el.contextMenuItems.innerHTML = '';
    [
        ['downloadRepo', 'fa-download', '下载ZIP (代理)'],
        ['renameRepo', 'fa-pencil', '重命名'],
        ['deleteRepo', 'fa-trash', '删除', 'text-red-400']
    ].forEach(([action, icon, text, className = '']) => {
        const item = document.createElement('a');
        item.className = `block px-4 py-2 text-sm hover:bg-[#6b7280]/20 ${className}`;
        item.dataset.action = action;
        item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
        item.addEventListener('click', () => {
            handleRepoContextMenuAction(action, state.selectedRepo);
            hideContextMenu();
        });
        el.contextMenuItems.appendChild(item);
    });
}
function renderContextMenuItems(file) {
    el.contextMenuItems.innerHTML = '';
    const isDir = file.type === 'dir';
    const items = isDir
        ? [['download', 'fa-download', '下载 (ZIP)'],
           ['rename', 'fa-pencil', '重命名'],
           ['delete', 'fa-trash', '删除', 'text-red-400']]
        : [['download', 'fa-download', '下载'],
           ['copyLink', 'fa-link', '复制链接'],
           ['copyProxy', 'fa-share', '代理链接'],
           ['edit', 'fa-edit', '编辑'],
           ['rename', 'fa-pencil', '重命名'],
           ['delete', 'fa-trash', '删除', 'text-red-400']];
    items.forEach(([action, icon, text, className = '']) => {
        const item = document.createElement('a');
        item.className = `block px-4 py-2 text-sm hover:bg-[#6b7280]/20 ${className}`;
        item.dataset.action = action;
        item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
        item.addEventListener('click', () => {
            handleContextMenuAction(action, state.selectedFile);
            hideContextMenu();
        });
        el.contextMenuItems.appendChild(item);
    });
}
const hideContextMenu = () => {
    const menu = el.contextMenu;
    if (menu.classList.contains('hidden') && menu.style.display === 'none') return;
    let start = null, duration = 150;
    function animate(timestamp) {
        if (!start) start = timestamp;
        const progress = Math.min((timestamp - start) / duration, 1);
        menu.style.opacity = (1 - progress).toString();
        menu.style.transform = `scale(${1 - 0.2 * progress})`;
        if (progress < 1) requestAnimationFrame(animate);
        else {
            menu.classList.add('hidden');
            menu.style.display = 'none';
            state.selectedFile = null;
            state.selectedRepo = null;
        }
    }
    requestAnimationFrame(animate);
};
function handleContextMenuAction(action, file) {
    switch (action) {
        case 'download': downloadFile(file); break;
        case 'copyLink': copyLink(file); break;
        case 'copyProxy': copyProxyLink(file); break;
        case 'edit': editFile(file); break;
        case 'rename': renameItem(file); break;
        case 'delete': deleteItem(file); break;
    }
}
function handleRepoContextMenuAction(action, repo) {
    switch (action) {
        case 'downloadRepo': downloadRepoAsZip(repo); break;
        case 'renameRepo': renameRepo(repo); break;
        case 'deleteRepo': deleteRepo(repo); break;
    }
}
function downloadRepoAsZip(repo) {
    const zipUrl = `${state.proxyUrl}https://github.com/${repo.full_name}/archive/refs/heads/${repo.default_branch || 'main'}.zip`;
    const a = document.createElement('a');
    a.href = zipUrl;
    a.download = `${repo.name}.zip`;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => document.body.removeChild(a), 500);
    showToast(`正在下载 ${repo.name}.zip`);
}

<!-- 编辑器 -->
function showEditModal() {
    el.editModal.classList.remove('hidden');
    el.editModal.classList.add('flex');
    el.editorOverlay.classList.add('opacity-100', 'pointer-events-auto');
    setTimeout(adjustEditorDimensions, 10);
}
function hideEditModal() {
    el.editModal.classList.add('hidden');
    el.editModal.classList.remove('flex');
    state.editingFile = state.fileSha = state.originalContent = '';
    el.saveEdit.className = 'flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#6b7280] hover:bg-[#4b5563] transition-colors rounded-lg p-3';
}
function showEditStatus(text, type) {
    el.editStatus.textContent = text;
    el.editStatus.className = `p-3 m-[0.1rem_0] rounded-[0.375rem] ${type}`;
}
function adjustEditorDimensions() {
    const viewportHeight = window.innerHeight;
    const targetEditorHeight = viewportHeight * 0.6;
    const modal = el.editModal.querySelector('.min-h-[60vh]');
    const otherElementsHeight =
        modal.querySelector('div.flex.justify-between').offsetHeight +
        el.editStatus.offsetHeight +
        modal.querySelector('div.flex.gap-3').offsetHeight + 30;
    modal.style.height = `${targetEditorHeight + otherElementsHeight}px`;
    el.fileContent.style.height = `${targetEditorHeight}px`;
    el.fileContent.focus();
}
async function editFile(file) {
    state.editingFile = file;
    el.editFileName.textContent = `编辑 ${file.name}`;
    el.fileContent.value = '';
    showEditStatus('', '');
    showEditModal();
    try {
        const [owner, repo] = state.currentRepo.split('/');
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
            headers: { 'Authorization': `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
        });
        if (!res.ok) {
            const err = await res.json();
            el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
            showEditStatus(`加载失败：${err.message}`, 'bg-[#f8d7da] text-[#842029]');
            return;
        }
        const data = await res.json();
        const content = decodeURIComponent(escape(atob(data.content)));
        el.fileContent.value = content;
        state.originalContent = content;
        state.fileSha = data.sha;
        el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
        el.fileContent.addEventListener('input', checkContentChanges);
    } catch (e) {
        el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
        showEditStatus(`错误：${e.message}`, 'bg-[#f8d7da] text-[#842029]');
        console.error(e);
    }
}
function checkContentChanges() {
    const isModified = el.fileContent.value !== state.originalContent;
    el.saveEdit.className = `flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] ${isModified ? 'bg-[#3b82f6] hover:bg-green-600' : 'bg-[#6b7280] hover:bg-[#4b5563]'} transition-colors rounded-lg p-3`;
}
async function saveEditedFile() {
    if (!state.editingFile || !state.fileSha) return;
    const currentContent = el.fileContent.value;
    if (currentContent === state.originalContent) {
        showToast('未检测到修改');
        return;
    }
    el.editorOverlay.classList.add('opacity-100', 'pointer-events-auto');
    try {
        const [owner, repo] = state.currentRepo.split('/');
        const encodedContent = btoa(unescape(encodeURIComponent(currentContent)));
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${state.editingFile.path}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${state.token}`,
                'Content-Type': 'application/json',
                'User-Agent': 'Mozilla/5.0'
            },
            body: JSON.stringify({
                message: `Update ${state.editingFile.name} via web editor`,
                content: encodedContent,
                sha: state.fileSha
            })
        });
        if (!res.ok) {
            const err = await res.json();
            el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
            showEditStatus(`保存失败：${err.message}`, 'bg-[#f8d7da] text-[#842029]');
            return;
        }
        const result = await res.json();
        state.fileSha = result.content.sha;
        state.originalContent = currentContent;
        el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
        showToast('文件已保存');
        showSaveNotification();
        fetchFiles();
        el.saveEdit.className = 'flex-1 box-shadow-[5px_5px_10px_rgba(0,0,0,0.3),-5px_-5px_10px_rgba(75,85,99,0.1)] bg-[#6b7280] hover:bg-[#4b5563] transition-colors rounded-lg p-3';
    } catch (e) {
        el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
        showEditStatus(`错误：${e.message}`, 'bg-[#f8d7da] text-[#842029]');
        console.error(e);
    }
}

<!-- 文件下载/复制/重命名/删除 -->
async function downloadFile(item) {
    try {
        showToast(`准备下载 ${item.name}`);
        let url = '';
        const downloadName = item.name;
        if (item.type === 'dir') {
            const [owner, repo] = state.currentRepo.split('/');
            url = `${state.proxyUrl}https://github.com/${owner}/${repo}/archive/refs/heads/main.zip?path=${encodeURIComponent(item.path)}`;
        } else {
            const rawUrl = item.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            url = `${state.proxyUrl}${rawUrl}`;
        }
        const response = await fetch(url);
        if (!response.ok) throw new Error(`下载失败 (${response.status})`);
        const blob = await response.blob();
        const objectUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = objectUrl;
        a.download = downloadName;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(objectUrl);
        }, 500);
        showToast(`开始下载 ${downloadName}`);
    } catch (e) {
        showToast(`下载出错: ${e.message}`);
        console.error(e);
    }
}
function copyLink(file) {
    const rawUrl = file.download_url || file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
    navigator.clipboard.writeText(rawUrl).then(() => {
        showToast('Raw 链接已复制');
    }).catch(e => {
        showToast('复制失败');
        console.error(e);
    });
}
function copyProxyLink(file) {
    if (!file.download_url) return showToast('无代理链接可用');
    const proxyUrl = `${state.proxyUrl}${file.download_url}`;
    navigator.clipboard.writeText(proxyUrl).then(() => {
        showToast('代理链接已复制');
    }).catch(e => {
        showToast('复制失败');
        console.error(e);
    });
}
async function renameItem(item) {
    // ...（同你原有的 renameItem 逻辑，已优化合并，略）
}
async function deleteItem(item) {
    // ...（同你原有的 deleteItem 逻辑，已优化合并，略）
}

<!-- 上传功能 -->
function initUploadFeatures() {
    if (window.uploadFeaturesInitialized) return;
    window.uploadFeaturesInitialized = true;
    if (el.uploadBtn) el.uploadBtn.addEventListener('click', handleUploadClick);
    if (el.fileUploadInput) el.fileUploadInput.addEventListener('change', handleFilesSelected);
}
function handleUploadClick() {
    if (!state || !state.currentRepo) {
        showToast('请先选择仓库');
        return;
    }
    if (el.fileUploadInput) {
        el.fileUploadInput.value = '';
        el.fileUploadInput.click();
    }
}
function handleFilesSelected(e) {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    if (el.uploadPanel) el.uploadPanel.classList.remove('hidden');
    if (el.uploadItems) el.uploadItems.innerHTML = '';
    files.forEach((file, index) => {
        const uploadItem = document.createElement('div');
        uploadItem.className = 'flex flex-col gap-1';
        uploadItem.innerHTML = `
            <div class="flex justify-between items-center text-sm">
                <span class="truncate max-w-[70%]">${file.name}</span>
                <span class="text-gray-400">${formatSize(file.size)}</span>
            </div>
            <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                <div class="upload-progress h-full bg-green-500 w-0 transition-all duration-300" data-index="${index}"></div>
            </div>
            <div class="text-xs text-gray-400 upload-status" data-index="${index}">等待上传...</div>
        `;
        if (el.uploadItems) el.uploadItems.appendChild(uploadItem);
    });
    uploadFilesInSequence(files, 0);
    e.target.value = '';
}
function uploadFilesInSequence(files, index) {
    if (index >= files.length) {
        setTimeout(() => {
            if (el.uploadPanel) el.uploadPanel.classList.add('hidden');
            if (typeof fetchFiles === 'function') fetchFiles();
        }, 2000);
        return;
    }
    const file = files[index];
    const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
    if (statusElement) statusElement.textContent = '准备上传...';
    uploadSingleFile(file, index)
        .then(() => uploadFilesInSequence(files, index + 1))
        .catch(() => uploadFilesInSequence(files, index + 1));
}
async function uploadSingleFile(file, index) {
    return new Promise((resolve, reject) => {
        const progressBar = document.querySelector(`.upload-progress[data-index="${index}"]`);
        const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
        if (progressBar) progressBar.style.width = '5%';
        if (statusElement) statusElement.textContent = '正在处理文件...';
        const reader = new FileReader();
        if (file.type.includes('text') || file.size < 1024 * 1024) reader.readAsText(file);
        else reader.readAsDataURL(file);
        reader.onload = async (e) => {
            try {
                if (statusElement) statusElement.textContent = '正在编码内容...';
                let content;
                if (e.target.result.startsWith('data:')) content = e.target.result.split(',')[1];
                else content = btoa(unescape(encodeURIComponent(e.target.result)));
                if (progressBar) progressBar.style.width = '30%';
                if (!state || !state.currentRepo) throw new Error('未选择仓库');
                const fileName = file.name;
                const filePath = state.currentPath ? `${state.currentPath}${fileName}` : fileName;
                const [owner, repo] = state.currentRepo.split('/');
                if (statusElement) statusElement.textContent = '正在上传...';
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${state.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0'
                    },
                    body: JSON.stringify({
                        message: `Upload ${fileName}`,
                        content: content
                    }),
                    signal: AbortSignal.timeout(60000)
                });
                if (progressBar) progressBar.style.width = '100%';
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `上传失败: HTTP ${response.status}`);
                }
                if (statusElement) {
                    statusElement.textContent = '上传成功';
                    statusElement.className = 'text-xs text-green-400 upload-status';
                }
                if (typeof showToast === 'function') showToast(`文件 "${fileName}" 上传成功`);
                resolve();
            } catch (error) {
                if (statusElement) {
                    statusElement.textContent = `失败: ${error.message.substring(0, 20)}...`;
                    statusElement.className = 'text-xs text-red-400 upload-status';
                }
                if (typeof showToast === 'function') showToast(`文件 "${file.name}" 上传失败`);
                reject(error);
            }
        };
        reader.onerror = () => {
            if (statusElement) {
                statusElement.textContent = '文件读取失败';
                statusElement.className = 'text-xs text-red-400 upload-status';
            }
            if (typeof showToast === 'function') showToast(`无法读取文件: ${file.name}`);
            reject(new Error('文件读取失败'));
        };
    });
}
if (window.el) initUploadFeatures();
else document.addEventListener('DOMContentLoaded', initUploadFeatures);

<!-- 媒体预览 -->
const initMediaPreview = () => {
    const p = document.createElement('div');
    p.id = 'mediaPreview';
    p.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center hidden';
    p.innerHTML = `<div class="max-w-[66%] max-h-[66vh]">
        <img src="" class="max-w-full max-h-[80vh] object-contain hidden">
        <video controls class="max-w-full max-h-[80vh] object-contain hidden"></video>
    </div>`;
    document.body.appendChild(p);
    const [img, video] = [p.querySelector('img'), p.querySelector('video')];
    p.onclick = () => {
        p.classList.add('hidden');
        img.src = video.src = '';
        video.pause();
        [img, video].forEach(el => el.classList.add('hidden'));
    };
    document.getElementById('fileList').addEventListener('click', e => {
        if (e.target.closest('.flex.gap-1,button')) return;
        const item = e.target.closest('div[class*="box-shadow"]');
        if (!item) return;
        const name = item.querySelector('.font-medium').textContent;
        const ext = name.split('.').pop()?.toLowerCase();
        const file = state.files.find(f => f.name === name);
        if (!file) return;
        if (file.type !== 'file') return;
        const rawUrl = file.html_url.replace('github.com','raw.githubusercontent.com').replace('/blob/','/');
        const url = `https://gh-proxy.com/${rawUrl}`;
        if (['png','jpg','jpeg','gif','webp','bmp','svg'].includes(ext)) {
            img.src = url;
            img.classList.remove('hidden');
            video.classList.add('hidden');
        } else if (['mp4','webm','ogg','mov','avi','mkv'].includes(ext)) {
            video.src = url;
            video.classList.remove('hidden');
            img.classList.add('hidden');
            video.load();
        } else return;
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.imagePreviewAction = true;
        p.classList.remove('hidden');
    }, true);
};
document.addEventListener('DOMContentLoaded', () => setTimeout(initMediaPreview, 1000));

<!-- 音频播放 -->
function initAudioPlayer() {
    let audio = null, currentFile = null;
    const audioExts = ['mp3', 'wav', 'ogg', 'flac', 'm4a'];
    function getAudio() { return audio || (audio = new Audio()); }
    function showPlayStatus(message) {
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMessage');
        toastMsg.style.whiteSpace = 'nowrap';
        toastMsg.style.overflow = 'hidden';
        toastMsg.style.textOverflow = 'ellipsis';
        toastMsg.textContent = message;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }
    document.querySelector('#fileList').addEventListener('click', (e) => {
        const fileItem = e.target.closest('div[class*="box-shadow"]');
        if (!fileItem) return;
        const index = Array.from(el.fileList.children).indexOf(fileItem);
        const file = state.files[index];
        if (!file) return;
        const fileNameWithoutExt = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
        const ext = file.name.split('.').pop()?.toLowerCase();
        if (!audioExts.includes(ext)) return;
        e.stopImmediatePropagation();
        const audio = getAudio();
        const isSameFile = currentFile?.path === file.path;
        if (isSameFile) {
            if (audio.paused) {
                audio.play();
                showPlayStatus(`正在播放: ${fileNameWithoutExt}`);
            } else {
                audio.pause();
                showPlayStatus(`已暂停: ${fileNameWithoutExt}`);
            }
        } else {
            currentFile = file;
            const rawUrl = file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            audio.src = `https://gh-proxy.com/${rawUrl}`;
            audio.play();
            showPlayStatus(`正在播放: ${fileNameWithoutExt}`);
        }
    }, true);
}
document.addEventListener('DOMContentLoaded', initAudioPlayer);

</script>


<!-- 新建文件夹' : '新建仓库' -->
<script>
async function createFolder() {
    const inRepo = !!state.currentRepo;
    showModal(`
        <div class="relative">
            <h3 class="font-bold mb-4">${inRepo ? '新建文件夹' : '新建仓库'}</h3>
            <div id="chineseToast" class="absolute top-2 right-2 bg-red-600 text-white px-2 py-1 rounded text-xs hidden">
                名称不能含中文
            </div>
            <input id="newName" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4" 
                   placeholder="${inRepo ? '输入文件夹名称' : '输入英文仓库名称'}"
                   onkeypress="${!inRepo ? 'return allowOnlyEnglish(event)' : ''}"
                   oninput="${!inRepo ? 'checkAndBlockChinese(this)' : ''}">

            ${!inRepo ? `
                <textarea id="repoDesc" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4 min-h-[120px]" placeholder="输入仓库描述"></textarea>
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="isPublic" class="mr-2 accent-green-500" checked>
                    <label for="isPublic" class="text-white">公开仓库</label>
                </div>
            ` : ''}
            
            <div class="flex gap-3">
                <button id="cancelCreate" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
                <button id="confirmCreate" class="flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed" disabled>确认</button>
            </div>
        </div>
    `);

    const nameInput = document.getElementById('newName');
    const confirmBtn = document.getElementById('confirmCreate');
    const descInput = !inRepo ? document.getElementById('repoDesc') : null;
    const publicCheckbox = !inRepo ? document.getElementById('isPublic') : null;
    const chineseToast = document.getElementById('chineseToast');

    const updateButtonState = () => {
        const name = nameInput.value.trim();
        // 仅对新建仓库验证中文，文件夹不验证
        const hasChinese = !inRepo && /[\u4e00-\u9fa5]/.test(name);
        const nameValid = name !== '' && (!hasChinese || inRepo);
        const isRepoValid = !inRepo ? nameValid : nameValid;
        
        // 仅新建仓库时显示中文提示
        chineseToast.classList.toggle('hidden', !hasChinese || inRepo);
        confirmBtn.disabled = !isRepoValid;
        confirmBtn.className = isRepoValid 
            ? 'flex-1 p-3 bg-green-600 hover:bg-green-500 text-white rounded' 
            : 'flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed';
    };

    nameInput.oninput = updateButtonState;
    if (!inRepo) {
        descInput.oninput = updateButtonState;
    }

    confirmBtn.onclick = async () => {
        const name = nameInput.value.trim();
        if (!name) return;

        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `创建中<span class="spinner-container"><<<i class="fa fa-spinner fa-spin ml-2"></</</i></span>`;

        try {
            if (inRepo) {
                const [owner, repo] = state.currentRepo.split('/');
                const path = state.currentPath ? `${state.currentPath}/${name}` : name;
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}/.gitkeep`, {
                    method: 'PUT',
                    headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `create folder ${name}`, content: '' })
                });
                showToast(`已创建文件夹: ${name}`);
                hideModal();
                fetchFiles();
            } else {
                const description = descInput.value.trim();
                const isPublic = publicCheckbox.checked;
                
                const res = await fetch(`https://api.github.com/user/repos`, {
                    method: 'POST',
                    headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name,
                        description: description,
                        private: !isPublic
                    })
                });

                if (!res.ok) throw new Error('创建仓库失败');
                showToast(`已创建仓库: ${name}`);
                hideModal();
                fetchRepos();
            }
        } catch (e) {
            showToast(`失败: ${e.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '创建';
        }
    };

    document.getElementById('cancelCreate').onclick = hideModal;
}

function showRepoListView() {
    el.repoList.classList.remove('hidden');
    el.fileList.classList.add('hidden');
    el.pathNavContainer.classList.add('hidden');
    el.currentRepo.textContent = '选择仓库';
    state.currentRepo = null;
    state.currentPath = '';
}

</script>

<!--  删除 重命名 -->
<script>
// 重命名仓库
function renameRepo(repo) {
    showModal(`
        <div class="relative">
            <h3 class="font-bold mb-4">重命名仓库: ${repo.name}</h3>
            <div id="chineseToast" class="absolute top-2 right-2 bg-red-600 text-white px-2 py-1 rounded text-xs hidden">
                名称不能含中文
            </div>
            <input id="newRepoName" value="${repo.name}" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4" 
                   onkeypress="return /[a-zA-Z0-9-_]/i.test(event.key)" 
                   oninput="this.value = this.value.replace(/[^\w-]/g, '')">
            <textarea id="newRepoDesc" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4 min-h-[80px]" 
                      placeholder="输入仓库描述">${repo.description || ''}</textarea>
            <div class="flex gap-3">
                <button id="cancelRenameRepo" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
                <button id="confirmRenameRepo" class="flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed" disabled>确认</button>
            </div>
        </div>
    `);

    const nameInput = document.getElementById('newRepoName');
    const descInput = document.getElementById('newRepoDesc');
    const confirmBtn = document.getElementById('confirmRenameRepo');
    const chineseToast = document.getElementById('chineseToast');

    const updateButtonState = () => {
        const newName = nameInput.value.trim();
        const newDesc = descInput.value.trim();
        const hasChinese = /[\u4e00-\u9fa5]/.test(newName);
        const nameChanged = newName !== repo.name;
        const descChanged = newDesc !== (repo.description || '');
        const isModified = (nameChanged || descChanged) && !hasChinese;

        chineseToast.classList.toggle('hidden', !hasChinese);
        
        confirmBtn.disabled = !isModified;
        confirmBtn.className = isModified 
            ? 'flex-1 p-3 bg-green-600 hover:bg-green-500 text-white rounded' 
            : 'flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed';
    };

    nameInput.oninput = updateButtonState;
    descInput.oninput = updateButtonState;

    confirmBtn.onclick = async () => {
        const newName = nameInput.value.trim();
        const newDesc = descInput.value.trim();
        if (newName === repo.name && newDesc === (repo.description || '')) return;

        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `处理中<span class="spinner-container"><i class="fa fa-spinner fa-spin mr-2"></</i></span>`; 
        
        try {
            const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${state.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: newName, description: newDesc })
            });

            if (!res.ok) throw new Error((await res.json()).message || '修改失败');
            
            showToast(`仓库信息已更新`);
            hideModal();
            state.repos = [];
            el.repoList.innerHTML = '';
            fetchRepos();
        } catch (e) {
            showToast(`修改失败: ${e.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '确认';
        }
    };

    document.getElementById('cancelRenameRepo').onclick = hideModal;
}
    
    // 删除仓库
    function deleteRepo(repo) {
        showModal(`
            <h3 class="font-bold mb-4">确认删除仓库</h3>
            <p class="mb-4 text-gray-300">确定要删除仓库 "${repo.name}" 吗？此操作不可撤销！</p>
            <div class="flex gap-3">
                <button id="cancelDeleteRepo" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
                <button id="confirmDeleteRepo" class="flex-1 p-3 bg-red-600 hover:bg-red-500 text-white rounded">确认删除</button>
            </div>
        `);
        const confirmBtn = document.getElementById('confirmDeleteRepo');
        confirmBtn.onclick = async () => {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `删除中<span class="spinner-container"><i class="fa fa-spinner fa-spin mr-2"></i></span>`; 
            try {
                const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${state.token}` }
                });
                if (!res.ok) throw new Error((await res.json()).message || '删除失败');
                showToast(`仓库 "${repo.name}" 已删除`);
                hideModal();
                fetchRepos();
            } catch (e) {
                showToast(`删除失败: ${e.message}`);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '确认删除';
            }
        };
        document.getElementById('cancelDeleteRepo').onclick = hideModal;
    }
    
    // 上下文菜单动作处理
    function handleContextMenuAction(action, file) {
        switch(action) {
            case 'download': downloadFile(file); break;
            case 'copyLink': copyLink(file); break;
            case 'copyProxy': copyProxyLink(file); break;
            case 'edit': editFile(file); break;
            case 'rename': renameItem(file); break;
            case 'delete': deleteItem(file); break;
        }
    }
    
    // 仓库上下文菜单动作处理
    function handleRepoContextMenuAction(action, repo) {
        switch(action) {
            case 'downloadRepo': downloadRepoAsZip(repo); break;
            case 'renameRepo': renameRepo(repo); break;
            case 'deleteRepo': deleteRepo(repo); break;
        }
    }
</script>


<!-- 文件删除 -->
<script>
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

async function deleteItem(item) {
  const isDir = item.type === 'dir';
  const safeName = escapeHtml(item.name); // 转义文件名
  
  const confirmMessage = isDir
    ? `确定要删除文件夹"${safeName}"吗？这将删除该文件夹及其所有内容。`
    : `确定要删除文件"${safeName}"吗？此操作不可撤销。`;

  showModal(`
    <h3 class="font-bold mb-4">确认删除</h3>
    <p class="mb-4 text-gray-300">${confirmMessage}</p>
    <div class="flex gap-3">
      <button id="cancelDelete" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
      <button id="confirmDelete" class="flex-1 p-3 bg-red-600 hover:bg-red-500 text-white rounded">确认删除</button>
    </div>
  `);

  const confirmBtn = document.getElementById('confirmDelete');
  const cancelBtn = document.getElementById('cancelDelete');
  const initialBtnHTML = confirmBtn.innerHTML; // 保存初始状态

  // 删除文件函数封装
  const deleteFile = async (path, sha, name) => {
    const [owner, repo] = state.currentRepo.split('/');
    const res = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
      {
        method: 'DELETE',
        headers: {
          Authorization: `token ${state.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Delete ${name}`,
          sha: sha
        })
      }
    );

    if (!res.ok) {
      const errorData = await res.json();
      if (res.status === 409) {
        throw new Error(`操作冲突：${errorData.message || '请刷新后重试'}`);
      } else {
        throw new Error(errorData.message || `删除失败 (HTTP ${res.status})`);
      }
    }
  };

  // 递归获取所有文件（带分页）
  const getAllFiles = async (path) => {
    const [owner, repo] = state.currentRepo.split('/');
    let allFiles = [];
    let page = 1;
    let hasMore = true;

    while (hasMore) {
      const res = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${path}?page=${page}&per_page=100`,
        { headers: { Authorization: `token ${state.token}` } }
      );

      if (!res.ok) return [];
      
      const items = await res.json();
      if (!Array.isArray(items)) return [];
      
      for (const i of items) {
        if (i.type === 'dir') {
          const subFiles = await getAllFiles(i.path);
          allFiles = [...allFiles, ...subFiles];
        } else {
          allFiles.push(i);
        }
      }
      
      // 检查是否有更多页面
      const linkHeader = res.headers.get('Link');
      hasMore = linkHeader && linkHeader.includes('rel="next"');
      page++;
    }
    return allFiles;
  };

  const performDelete = async () => {
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `处理中 <span class="spinner-container"><i class="fa fa-spinner fa-spin ml-2"></i></span>`;
    
    try {
      const [owner, repo] = state.currentRepo.split('/');
      const targetPath = item.path;

      if (isDir) {
        const allFiles = await getAllFiles(targetPath);
        for (const f of allFiles) {
          await deleteFile(f.path, f.sha, f.name);
        }
        showToast(`文件夹"${safeName}"已删除`);
      } else {
        await deleteFile(targetPath, item.sha, item.name);
        showToast(`文件"${safeName}"已删除`);
      }
      
      hideModal();
      fetchFiles();
    } catch (error) {
      showToast(`删除失败: ${error.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = initialBtnHTML; // 恢复初始状态
    }
  };

  // 使用一次性事件监听
  confirmBtn.addEventListener('click', performDelete, { once: true });
  cancelBtn.addEventListener('click', hideModal, { once: true });
}
</script>


<!-- 文件文件夹重命名 -->
<script>
async function renameItem(item) {
    const isDir = item.type === 'dir';
    const binExt = ['.mp3','.mp4','.jpg','.jpeg','.png','.gif','.zip','.rar','.7z','.exe','.pdf','.webp','.flac','.wav','.apk'];
    const isBin = name => binExt.some(e => name.toLowerCase().endsWith(e));
    if (!isDir && isBin(item.name)) return showToast('禁止重命名二进制文件');

    let warn = '', loading = document.createElement('div');
    loading.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 text-white text-lg';
    loading.innerHTML = `<div class="flex items-center gap-3"><i class="fa fa-spinner fa-spin text-xl"></i>加载中...</div>`;
    document.body.appendChild(loading);

    if (isDir) {
        const [owner, repo] = state.currentRepo.split('/');
        const check = async p => {
            const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${p}`, {
                headers: { Authorization: `token ${state.token}` }
            });
            if (!r.ok) return false;
            const d = await r.json();
            for (const i of d) {
                if (i.type === 'file' && isBin(i.name)) return true;
                if (i.type === 'dir' && await check(i.path)) return true;
            }
            return false;
        };
        if (await check(item.path)) {
            warn = '<p class="text-red-500 text-sm mt-2">警告：此文件夹包含图片或音视频压缩包等二进制文件，重命名会导致二进制文件损坏，其他文件不受影响，不是俺不做这个功能，官方不支持！</p>';
        }
    }

    loading.remove();

    showModal(`
        <h3 class="font-bold mb-4">重命名 ${isDir ? '文件夹' : '文件'}: ${item.name}</h3>
        <input id="newName" value="${item.name}" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4">
        <div class="flex gap-3">
            <button id="cancelRename" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
            <button id="confirmRename" class="flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed" disabled>确认</button>
        </div>${warn}
    `);

    const i = document.getElementById('newName'), b = document.getElementById('confirmRename');
    i.oninput = () => {
        const v = i.value.trim();
        const ok = v && v !== item.name;
        b.disabled = !ok;
        b.className = ok ? 'flex-1 p-3 bg-green-600 hover:bg-green-500 text-white rounded' : 'flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed';
    };
    b.onclick = async () => {
        const v = i.value.trim();
        if (!v || v === item.name) return;
        b.disabled = true;
        b.innerHTML = `保存中<i class="fa fa-spinner fa-spin ml-2"></i>`;
        try {
            const [owner, repo] = state.currentRepo.split('/');
            const oldPath = item.path;
            const base = oldPath.substring(0, oldPath.lastIndexOf(item.name));
            const newPath = base + v;

            if (isDir) {
                const getAll = async path => {
                    const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                        headers: { Authorization: `token ${state.token}` }
                    });
                    if (!r.ok) return [];
                    const d = await r.json(), a = [];
                    for (const i of d) a.push(...(i.type === 'dir' ? await getAll(i.path) : [i]));
                    return a;
                };
                const files = await getAll(oldPath);
                for (const f of files) {
                    const to = f.path.replace(oldPath, newPath);
                    const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
                        headers: { Authorization: `token ${state.token}` }
                    })).json();
                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${to}`, {
                        method: 'PUT',
                        headers: {
                            Authorization: `token ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message: `Move ${f.name}`, content: d.content || '', sha: d.sha })
                    });
                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
                        method: 'DELETE',
                        headers: {
                            Authorization: `token ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message: `Delete ${f.name}`, sha: d.sha })
                    });
                }
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `token ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: `Delete folder ${item.name}`, sha: item.sha })
                });
            } else {
                const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    headers: { Authorization: `token ${state.token}` }
                })).json();
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${newPath}`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: `Rename to ${v}`, content: d.content, sha: d.sha })
                });
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `token ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: `Delete old file`, sha: d.sha })
                });
            }
            showToast(`重命名成功: ${v}`);
            hideModal();
            fetchFiles();
        } catch (e) {
            showToast(`失败: ${e.message}`);
            b.disabled = false;
            b.innerHTML = '确认';
        }
    };
    document.getElementById('cancelRename').onclick = hideModal;
}
</script>
</body>
</html>